<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>2048 - Simple</title>
<style>
  :root{
    --bg:#faf8ef;
    --board:#bbada0;
    --cell:#cdc1b4;
    --empty:#eee4da;
    --font:'Segoe UI', Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    background:var(--bg);
    font-family:var(--font);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    margin:0;
    padding:20px;
  }
  .container{
    width:360px;
  }
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  h1{margin:0;font-size:28px}
  .controls{display:flex;gap:8px;align-items:center}
  button{padding:8px 12px;border-radius:6px;border:0;background:#8f7a66;color:white;cursor:pointer}
  .score{
    background:#f2b179;padding:8px 12px;border-radius:6px;color:#fff;
    font-weight:700;
  }

  .board{
    background:var(--board);
    padding:12px;
    border-radius:8px;
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:12px;
  }
  .tile{
    height:76px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:24px;
    border-radius:6px;
    background:var(--cell);
    color:#776e65;
    user-select:none;
  }
  .tile.empty{background:var(--empty);color:transparent}
  /* basic colors by value (partial) */
  .v2{background:#eee4da}
  .v4{background:#ede0c8}
  .v8{background:#f2b179;color:#fff}
  .v16{background:#f59563;color:#fff}
  .v32{background:#f67c5f;color:#fff}
  .v64{background:#f65e3b;color:#fff}
  .v128{background:#edcf72;color:#fff;font-size:20px}
  .v256{background:#edcc61;color:#fff;font-size:20px}
  .v512{background:#edc850;color:#fff;font-size:20px}
  .v1024{background:#edc53f;color:#fff;font-size:18px}
  .v2048{background:#edc22e;color:#fff;font-size:18px}

  .footer{margin-top:10px;font-size:12px;color:#776e65;text-align:center}
  .overlay{
    position:fixed;left:0;right:0;top:0;bottom:0;
    display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.45);
  }
  .panel{
    background:white;padding:24px;border-radius:8px;text-align:center;
    width:320px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>2048</h1>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="score" id="score">0</div>
      <div class="controls">
        <button id="btnNew">New</button>
        <button id="btnUndo">Undo</button>
      </div>
    </div>
  </div>

  <div class="board" id="board" aria-live="polite"></div>

  <div class="footer">
    用方向键或在手机上滑动来移动。目标：2048！<br/>
    简单实现，适合在 Cursor 或 任意编辑器中运行与修改。
  </div>
</div>

<script>
/* ====== 游戏逻辑（关键点） ====== */
const SIZE = 4;
let grid = [];
let score = 0;
let prevState = null; // 用于 Undo

function initGrid(){
  grid = Array.from({length:SIZE}, ()=>Array(SIZE).fill(0));
  score = 0;
  addRandomTile();
  addRandomTile();
  savePrev();
  render();
}

function savePrev(){
  prevState = {
    grid: grid.map(r => r.slice()),
    score
  };
}

function undo(){
  if(prevState){
    grid = prevState.grid.map(r => r.slice());
    score = prevState.score;
    render();
  }
}

function addRandomTile(){
  const empties = [];
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      if(grid[r][c] === 0) empties.push([r,c]);
    }
  }
  if(empties.length === 0) return false;
  const [r,c] = empties[Math.floor(Math.random()*empties.length)];
  grid[r][c] = Math.random() < 0.9 ? 2 : 4;
  return true;
}

/* 压缩并合并一行（向左处理），返回是否发生变化与得分增量 */
function processLine(oldLine){
  const line = oldLine.filter(v=>v!==0); // 压缩
  let gained = 0;
  for(let i=0;i<line.length-1;i++){
    if(line[i] === line[i+1]){
      line[i] *= 2;
      gained += line[i];
      line.splice(i+1,1);
    }
  }
  while(line.length < SIZE) line.push(0);
  const changed = line.some((v,i)=>v !== oldLine[i]);
  return {line, changed, gained};
}

/* 按方向移动：0=left,1=up,2=right,3=down */
function move(dir){
  let moved = false;
  let gained = 0;
  let newGrid = Array.from({length:SIZE}, ()=>Array(SIZE).fill(0));

  for(let i=0;i<SIZE;i++){
    let line;
    if(dir === 0){ // left - 每行原样
      line = grid[i].slice();
      const res = processLine(line);
      res.line.forEach((v,j)=> newGrid[i][j]=v);
      moved = moved || res.changed;
      gained += res.gained;
    } else if(dir === 2){ // right - 反转行处理
      line = grid[i].slice().reverse();
      const res = processLine(line);
      res.line.reverse().forEach((v,j)=> newGrid[i][j]=v);
      moved = moved || res.changed;
      gained += res.gained;
    } else if(dir === 1){ // up - 每列
      line = [];
      for(let r=0;r<SIZE;r++) line.push(grid[r][i]);
      const res = processLine(line);
      res.line.forEach((v,r)=> newGrid[r][i]=v);
      moved = moved || res.changed;
      gained += res.gained;
    } else if(dir === 3){ // down - 列反转
      line=[];
      for(let r=SIZE-1;r>=0;r--) line.push(grid[r][i]);
      const res = processLine(line);
      res.line.reverse().forEach((v,r)=> newGrid[r][i]=v);
      moved = moved || res.changed;
      gained += res.gained;
    }
  }

  if(moved){
    savePrev();
    grid = newGrid;
    score += gained;
    addRandomTile();
    render();
    if(isGameOver()) showGameOver();
  }
  return moved;
}

/* 判断是否还能移动或合并 */
function isGameOver(){
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      if(grid[r][c] === 0) return false;
      const v = grid[r][c];
      if(c+1 < SIZE && grid[r][c+1] === v) return false;
      if(r+1 < SIZE && grid[r+1][c] === v) return false;
    }
  }
  return true;
}

/* ====== 渲染 ====== */
const boardEl = document.getElementById('board');
const scoreEl = document.getElementById('score');

function render(){
  boardEl.innerHTML = '';
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const v = grid[r][c];
      const div = document.createElement('div');
      div.className = 'tile ' + (v===0 ? 'empty' : 'v'+v);
      div.textContent = v === 0 ? '' : v;
      boardEl.appendChild(div);
    }
  }
  scoreEl.textContent = score;
}

/* ====== 输入处理（键盘 + 触摸滑动） ====== */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowLeft') { e.preventDefault(); move(0); }
  else if(e.key === 'ArrowUp'){ e.preventDefault(); move(1); }
  else if(e.key === 'ArrowRight'){ e.preventDefault(); move(2); }
  else if(e.key === 'ArrowDown'){ e.preventDefault(); move(3); }
});

let touchStartX = 0, touchStartY = 0;
window.addEventListener('touchstart', e=>{
  const t = e.changedTouches[0];
  touchStartX = t.clientX;
  touchStartY = t.clientY;
});
window.addEventListener('touchend', e=>{
  const t = e.changedTouches[0];
  const dx = t.clientX - touchStartX;
  const dy = t.clientY - touchStartY;
  if(Math.abs(dx) < 20 && Math.abs(dy) < 20) return;
  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 0) move(2); else move(0);
  } else {
    if(dy > 0) move(3); else move(1);
  }
});

/* ====== UI 控件 ====== */
document.getElementById('btnNew').addEventListener('click', initGrid);
document.getElementById('btnUndo').addEventListener('click', undo);

/* 简单的结束提示 */
function showGameOver(){
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `<div class="panel">
    <h2>游戏结束</h2>
    <p>得分：${score}</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
      <button id="again">再来一次</button>
      <button id="close">关闭</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#again').addEventListener('click', ()=>{
    document.body.removeChild(overlay);
    initGrid();
  });
  overlay.querySelector('#close').addEventListener('click', ()=>{
    document.body.removeChild(overlay);
  });
}

/* 初始化游戏 */
initGrid();
</script>
</body>
</html>
